@page "/debug-slicer"
@using DCWC_TeamAssist.Services
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.PixelFormats
@inject ImageProcessingService ImageProcessor

<PageTitle>Debug: Roster Slicer</PageTitle>

<h1>?? Debug: Roster Slicer</h1>

<p>Test the roster image slicing to see if the grid alignment is correct.</p>

<div class="card mb-4">
    <div class="card-body">
        <h5>Configuration Parameters</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Sidebar Ratio: @_sidebarRatio.ToString("P0")</label>
                <input type="range" class="form-range" min="0.10" max="0.30" step="0.01" 
                       @bind="_sidebarRatio" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Card Aspect Ratio: @_cardAspectRatio.ToString("F2")</label>
                <input type="range" class="form-range" min="0.5" max="2.0" step="0.05" 
                       @bind="_cardAspectRatio" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Padding: @_padding px</label>
                <input type="range" class="form-range" min="0" max="20" step="1" 
                       @bind="_padding" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Columns: @_columns</label>
                <input type="range" class="form-range" min="5" max="10" step="1" 
                       @bind="_columns" @bind:event="oninput" />
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Upload Roster Screenshot</h5>
                <InputFile OnChange="HandleFileSelected" accept="image/*" class="form-control" />
                
                @if (!string.IsNullOrEmpty(_imagePreview))
                {
                    <div class="mt-3">
                        <img src="@_imagePreview" alt="Preview" class="img-fluid border rounded" />
                    </div>
                }
                
                @if (_processing)
                {
                    <div class="mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <span class="ms-2">Slicing image...</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        @if (_slicedCards.Any())
        {
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Sliced Character Cards (@_slicedCards.Count)</h5>
                    <p class="text-muted small">These are the individual cards extracted from the roster.</p>
                    
                    <div class="row g-2">
                        @foreach (var (card, index) in _slicedCards.Select((c, i) => (c, i)))
                        {
                            <div class="col-3">
                                <div class="card">
                                    <img src="@card" class="card-img-top" alt="Card @index" />
                                    <div class="card-body p-1 text-center">
                                        <small class="text-muted">Card @(index + 1)</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@if (_slicedCards.Any())
{
    <div class="alert alert-success mt-3">
        <h5>? Slicing Complete!</h5>
        <p>Extracted @_slicedCards.Count character cards. Review them above to verify alignment.</p>
        <p class="mb-0">
            <strong>Current Settings:</strong> 
            Sidebar: @_sidebarRatio.ToString("P0"), 
            Aspect: @_cardAspectRatio.ToString("F2"), 
            Padding: @_padding px, 
            Columns: @_columns
        </p>
    </div>
}

@code {
    private string _imagePreview = string.Empty;
    private bool _processing = false;
    private List<string> _slicedCards = new();
    
    // Configurable parameters
    private float _sidebarRatio = 0.18f;
    private float _cardAspectRatio = 1.0f;
    private int _padding = 5;
    private int _columns = 8; // Updated to 8 columns (was 7)
    private int _rows = 4;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _slicedCards.Clear();
        _processing = true;

        try
        {
            var file = e.File;
            
            if (file.Size > 10 * 1024 * 1024)
            {
                _processing = false;
                return;
            }

            // Read file
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            _imagePreview = $"data:{file.ContentType};base64,{base64}";

            StateHasChanged();

            // Load image
            var rosterImage = await ImageProcessor.LoadImageFromBytes(buffer);
            
            // Slice using current parameters
            var characterCards = ImageProcessor.SliceRoster(
                rosterImage, 
                _columns, 
                _rows, 
                _sidebarRatio, 
                _cardAspectRatio, 
                _padding
            );
            
            Console.WriteLine($"Sliced into {characterCards.Count} cards");

            // Convert to data URLs for display
            _slicedCards = await ImageProcessor.ConvertCardsToDataUrls(characterCards);

            // Cleanup
            foreach (var card in characterCards)
            {
                card.Dispose();
            }
            rosterImage.Dispose();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }
    }
}
