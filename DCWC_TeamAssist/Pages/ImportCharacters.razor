@page "/import"
@using DCWC_TeamAssist.Models
@using DCWC_TeamAssist.Services
@using Microsoft.JSInterop
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.PixelFormats
@inject UserCharacterService UserCharacterService
@inject CharacterDataService CharacterData
@inject ImageProcessingService ImageProcessor
@inject TemplateMatchingService TemplateMatcher
@inject TemplateStorageService TemplateStorage
@inject CardMetadataDetector MetadataDetector
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Import Characters</PageTitle>

<h1>?? Import Characters from Roster</h1>

<p class="lead">Upload a screenshot of your roster and I'll automatically detect all your characters!</p>

@if (_preloadingTemplates)
{
    <div class="alert alert-info">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading character portraits... (@_templatesLoaded / @_totalTemplates)</span>
        </div>
    </div>
}
else if (_templatesReady)
{
    <div class="alert alert-success">
        ? Ready! All @_totalTemplates character portraits preloaded for instant matching.
    </div>
}

<div class="alert alert-info">
    <h5>?? How it Works:</h5>
    <ul>
        <li>? Upload your roster screenshot</li>
        <li>? Automatically slices it into individual character cards</li>
        <li>? Detects each character using image recognition</li>
        <li>? Extracts rank (stars) and badge level</li>
        <li>? Review and import to your collection</li>
    </ul>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Upload Roster Screenshot</h5>
                <InputFile OnChange="HandleFileSelected" accept="image/*" class="form-control" />
                
                @if (!string.IsNullOrEmpty(_imagePreview))
                {
                    <div class="mt-3">
                        <img src="@_imagePreview" alt="Preview" class="img-fluid border rounded" style="max-height: 400px;" />
                    </div>
                }
            </div>
        </div>

        @if (_processing)
        {
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Processing...</h5>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: @(_progress)%"
                             aria-valuenow="@_progress" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @_progress%
                        </div>
                    </div>
                    <p class="text-muted small">Detecting characters...</p>
                </div>
            </div>
        }
    </div>

    <div class="col-md-6">
        @if (_results.Any())
        {
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">? Detected @_results.Count Characters</h5>
                    <p class="text-muted small">Review and adjust before importing.</p>

                    <div class="list-group mb-3">
                        @foreach (var result in _results)
                        {
                            var character = CharacterData.GetCharacterById(result.CharacterId);
                            if (character != null)
                            {
                                var maxBadge = character.Rarity == CharacterRarity.Epic ? 30 : 40;
                                var confidenceClass = result.Confidence > 0.5 ? "success" : "warning";

                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0">@character.Name</h6>
                                            <small class="text-muted">
                                                <span class="badge bg-@(character.Rarity == CharacterRarity.Legendary ? "warning" : "primary")">
                                                    @character.Rarity
                                                </span>
                                                <span class="badge bg-@confidenceClass">
                                                    @((int)(result.Confidence * 100))% match
                                                </span>
                                            </small>
                                        </div>
                                        <button class="btn btn-sm btn-danger" @onclick="() => RemoveResult(result)">
                                            ?
                                        </button>
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small mb-0">Rank: @result.Rank</label>
                                            <input type="range" class="form-range" min="1" max="15" 
                                                   @bind="result.Rank" @bind:event="oninput" />
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small mb-0">Badge: @result.BadgeLevel</label>
                                            <input type="range" class="form-range" min="1" max="@maxBadge" 
                                                   @bind="result.BadgeLevel" @bind:event="oninput" />
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @onclick="ImportCharactersToCollection" disabled="@(!_results.Any())">
                            Import @_results.Count Character(s)
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ClearResults">
                            Clear Results
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (_imported)
        {
            <div class="alert alert-success mt-3">
                <h5>? Import Successful!</h5>
                <p>@_importedCount character(s) have been added to your collection.</p>
                <a href="/characters" class="btn btn-primary">View My Characters</a>
            </div>
        }
    </div>
</div>

@code {
    private string _imagePreview = string.Empty;
    private bool _processing = false;
    private int _progress = 0;
    private List<CharacterDetectionResult> _results = new();
    private bool _imported = false;
    private int _importedCount = 0;
    private DotNetObjectReference<ImportCharacters>? _dotNetHelper;
    private Dictionary<string, Image<Rgba32>>? _templates;
    
    // Preloading state
    private bool _preloadingTemplates = false;
    private bool _templatesReady = false;
    private int _templatesLoaded = 0;
    private int _totalTemplates = 59;

    protected override async Task OnInitializedAsync()
    {
        await UserCharacterService.InitializeAsync();
        _dotNetHelper = DotNetObjectReference.Create(this);
        
        // Preload character portraits
        _preloadingTemplates = true;
        StateHasChanged();
        
        Console.WriteLine("?? Preloading character portraits...");
        
        try
        {
            _templates = await TemplateStorage.LoadAllTemplatesAsync();
            _templatesLoaded = _templates.Count;
            _totalTemplates = _templates.Count;
            _templatesReady = true;
            _preloadingTemplates = false;
            
            Console.WriteLine($"? Preloaded {_templates.Count} character portraits - ready for instant matching!");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"?? Error preloading portraits: {ex.Message}");
            _preloadingTemplates = false;
            StateHasChanged();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _results.Clear();
        _imported = false;
        _processing = true;
        _progress = 0;

        Console.WriteLine("=== AUTO-DETECT IMPORT STARTED ===");

        try
        {
            var file = e.File;
            Console.WriteLine($"?? File: {file.Name} ({file.Size / 1024:N0} KB)");
            
            if (file.Size > 10 * 1024 * 1024)
            {
                Console.WriteLine("? File too large (>10MB)");
                _processing = false;
                return;
            }

            // Read file
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            _imagePreview = $"data:{file.ContentType};base64,{base64}";

            _progress = 10;
            StateHasChanged();

            // Load image
            var rosterImage = await ImageProcessor.LoadImageFromBytes(buffer);
            Console.WriteLine($"? Image: {rosterImage.Width}x{rosterImage.Height}");
            
            _progress = 20;
            StateHasChanged();

            // Slice roster
            var characterCards = ImageProcessor.SliceRoster(rosterImage, columns: 7, rows: 4);
            Console.WriteLine($"?? Sliced into {characterCards.Count} cards");
            
            _progress = 30;
            StateHasChanged();

            // Use preloaded character templates (or load if not ready yet)
            if (_templates == null || _templates.Count == 0)
            {
                Console.WriteLine("?? Templates not preloaded yet, loading now...");
                _templates = await TemplateStorage.LoadAllTemplatesAsync();
            }
            else
            {
                Console.WriteLine($"? Using preloaded templates ({_templates.Count} characters) - instant matching!");
            }

            _progress = 40;
            StateHasChanged();

            // Process each card
            var allResults = new List<CharacterDetectionResult>();
            int cardIndex = 0;
            
            foreach (var card in characterCards)
            {
                cardIndex++;
                _progress = 40 + (int)((cardIndex / (float)characterCards.Count) * 50);
                StateHasChanged();

                try
                {
                    // Detect metadata (rank, badge, rarity)
                    var metadata = MetadataDetector.DetectMetadata(card);

                    // Match character
                    var match = TemplateMatcher.MatchCharacter(card, _templates);
                    
                    if (match.Similarity > 0.3)
                    {
                        var result = new CharacterDetectionResult
                        {
                            CharacterId = match.CharacterId,
                            CharacterName = match.CharacterName,
                            Confidence = match.Similarity,
                            Rank = metadata.Rank,
                            BadgeLevel = metadata.BadgeLevel
                        };
                        
                        allResults.Add(result);
                        Console.WriteLine($"   ? Card {cardIndex}: {match.CharacterName} ({match.Similarity:P0})");
                    }
                    else
                    {
                        Console.WriteLine($"   ?? Card {cardIndex}: No match ({match.Similarity:P0})");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"   ? Card {cardIndex}: {ex.Message}");
                }
                
                card.Dispose();
            }

            // Cleanup
            rosterImage.Dispose();
            foreach (var template in _templates.Values)
            {
                template.Dispose();
            }

            _results = allResults.OrderByDescending(r => r.Confidence).ToList();
            Console.WriteLine($"? COMPLETE: Found {_results.Count} characters");

            _progress = 100;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"? ERROR: {ex.Message}");
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public Task UpdateProgress(int progress)
    {
        _progress = progress;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void RemoveResult(CharacterDetectionResult result)
    {
        _results.Remove(result);
    }

    private void ClearResults()
    {
        _results.Clear();
        _imagePreview = string.Empty;
        _imported = false;
    }

    private async Task ImportCharactersToCollection()
    {
        _importedCount = 0;

        foreach (var result in _results)
        {
            await UserCharacterService.AddOrUpdateCharacterAsync(new UserCharacter
            {
                CharacterId = result.CharacterId,
                Rank = result.Rank,
                BadgeLevel = result.BadgeLevel,
                IsOwned = true
            });
            _importedCount++;
        }

        _imported = true;
        _results.Clear();
    }

    public void Dispose()
    {
        _dotNetHelper?.Dispose();
    }

    private class CharacterDetectionResult
    {
        public string CharacterId { get; set; } = string.Empty;
        public string CharacterName { get; set; } = string.Empty;
        public int Rank { get; set; } = 1;
        public int BadgeLevel { get; set; } = 1;
        public double Confidence { get; set; } = 0.0;
    }
}
